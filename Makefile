export PYTHONPATH := $(shell pwd)
ENV ?= DEV

.DEFAULT_GOAL := help

## === ENV SETUP ===

dev-env: ## Pr√©pare l‚Äôenvironnement de d√©veloppement
	chmod +x scripts/dev_env.sh
	./scripts/dev_env.sh

## === INIT COMMANDS ===

init-all: ## Initialise DB + migrations
	$(MAKE) init-db
	$(MAKE) init-migration

init-db: ## D√©marre PostgreSQL et cr√©e les BDD n√©cessaires
	docker-compose up -d
	@echo "‚è≥ Waiting for Postgres..."
	@sleep 3
	@until pg_isready -h localhost -p 5434 > /dev/null; do echo "‚è≥ Waiting for Postgres at localhost:5434..."; sleep 1; done
	@echo "‚úÖ Postgres is ready!"
	@echo "üß± Creating test database if needed"
	@docker exec -it stripe_db psql -U stripe_user -d postgres -c "CREATE DATABASE stripe_test;" || echo "‚úîÔ∏è stripe_test already exists."
	@echo "üß± Initializing tables in both databases"
	@python scripts/init_db.py
	@docker exec -it stripe_db psql -U stripe_user -d stripe_db -c "\dt"
	@docker exec -it stripe_db psql -U stripe_user -d stripe_test -c "\dt"
	@echo "‚úÖ Tables verified in both databases"

init-migration: ## Cr√©e la migration initiale si aucune n'existe
	$(MAKE) dev-env
	@if [ ! -d alembic/versions ] || [ -z "$$(ls -A alembic/versions)" ]; then \
		echo "üß± No migration found. Creating initial migration..."; \
		mkdir -p alembic/versions; \
		alembic revision --autogenerate -m "initial stripe schema"; \
		alembic upgrade head; \
	else \
		echo "‚úÖ Migrations already exist. Skipping init-migration."; \
	fi

## === MIGRATION COMMANDS ===

migrate: ## Cr√©e et applique une migration avec message `m=...`
	$(MAKE) dev-env
	alembic revision --autogenerate -m "$(m)"
	alembic upgrade head

upgrade-db: ## Applique toutes les migrations
	$(MAKE) dev-env
	alembic upgrade head

## === RESET COMMANDS ===

reset-all: ## R√©initialise compl√®tement la DB + migrations
	$(MAKE) reset-db
	$(MAKE) reset-migration

reset-db: ## Supprime les volumes et recr√©e les bases
	docker-compose down -v
	$(MAKE) init-db

reset-migration: ## Supprime et r√©g√©n√®re les migrations
	rm -rf alembic/versions/*
	mkdir -p alembic/versions
	$(MAKE) migrate m="reset migration"

## === STRIPE WORKFLOW ===

populate: ## ‚ö†Ô∏è Remplit Stripe (seulement en ENV=DEV)
ifeq ($(ENV),DEV)
	@echo "üöÄ Populating Stripe sandbox with test fixtures..."
	@python scripts/populate.py --fixture fixtures/stripe_batch_fixture.json
else
	@echo "‚ùå populate interdit en ENV=$(ENV). Utilisez ENV=DEV."
	@exit 1
endif

populate-force: ## Forcer le remplissage Stripe (ENV=DEV uniquement)
ifeq ($(ENV),DEV)
	@echo "üöÄ Force-populating Stripe sandbox with test fixtures..."
	@python scripts/populate.py --force --fixture fixtures/stripe_batch_fixture.json
else
	@echo "‚ùå populate-force interdit en ENV=$(ENV). Utilisez ENV=DEV."
	@exit 1
endif

fetch: ## T√©l√©charge les donn√©es depuis Stripe vers JSON
	@echo "üì• Fetching Stripe data into JSON files..."
	@chmod +x scripts/fetch_stripe_data.sh
	@chmod +x scripts/fetch_payment_methods.sh
	@./scripts/fetch_stripe_data.sh
	@./scripts/fetch_payment_methods.sh

ingest-%: ## Ingest une table sp√©cifique via --source=
	@echo "üì• Ingesting table '$*' using --source=$(SOURCE)"
	@python scripts/ingest/ingest_$*.py --source $(SOURCE) $(if $(FILE),--file $(FILE))

check-db-integrity: ## V√©rifie l'int√©grit√© de la base
	@echo "üîç Checking database integrity..."
	@python scripts/check_db_integrity.py

ingest-all: ## Ingest toutes les tables via --source
	@echo "üì¶ Ingesting ALL tables from --source=$(SOURCE)"
	@python scripts/ingest/ingest_all.py --source $(SOURCE) $(if $(JSON_DIR),--json-dir $(JSON_DIR))
	@python scripts/check_db_integrity.py

populate-all: ## ‚ö†Ô∏è Populate + Fetch + Ingest-All (DEV uniquement)
ifeq ($(ENV),DEV)
	@$(MAKE) populate
	@$(MAKE) fetch
	@$(MAKE) ingest-all SOURCE=json JSON_DIR=data/imported_stripe_data
else
	@echo "‚ùå populate-all interdit en ENV=$(ENV). Utilisez ENV=DEV."
	@exit 1
endif

clean: ## Supprime les donn√©es locales import√©es
	@echo "üßπ Nettoyage des donn√©es locales..."
	@rm -rf data/imported_stripe_data/*

all: init-all populate-all ## Initialise et peuple compl√®tement le projet (DEV)

## === HELP COMMAND ===

help: ## Affiche cette aide
	@echo "üîß Utilisation : make <commande> [ENV=DEV|PROD]"
	@echo ""
	@echo "üìò Commandes disponibles :"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
